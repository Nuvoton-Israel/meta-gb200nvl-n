From 98fec9bfa84b83ce49d7b19c816a4a31d201fb67 Mon Sep 17 00:00:00 2001
From: Joseph Liu <kwliu@nuvoton.com>
Date: Mon, 13 Oct 2025 17:08:46 +0800
Subject: [PATCH] fix meta-arm and meta-nuvoton break

commit fa1c3b95cada90ea4fc8ad22b9bf6bd24b4dc91c (origin/develop, origin/HEAD)
Author: dkodihalli <dkodihalli@nvidia.com>
Date:   Mon Oct 6 13:35:35 2025 -0700

    Update meta-nvidia

    Signed-off-by: dkodihalli <dkodihalli@nvidia.com>

Signed-off-by: Joseph Liu <kwliu@nuvoton.com>
---
 meta-arm/meta-arm-bsp/conf/layer.conf         |  2 +-
 meta-arm/meta-arm-toolchain/conf/layer.conf   |  2 +-
 meta-arm/meta-arm/conf/layer.conf             |  2 +-
 .../recipes-test/pacbti/test-pacbti.bb        |  2 +-
 meta-nuvoton/conf/layer.conf                  |  2 +-
 .../images/npcm7xx-bootblock_10.10.18.bb      | 26 -----------
 .../images/npcm7xx-bootblock_10.10.19.bb      |  2 +-
 .../images/npcm8xx-bootblock_0.4.3.bb         |  3 --
 .../images/npcm8xx-bootblock_0.4.6.bb         |  3 --
 .../images/npcm8xx-bootloader/settings.json   |  4 +-
 ....1.0.bb => npcm8xx-bootloader_04.03.08.bb} | 15 +++---
 .../images/npcm8xx-igps-native_04.00.07.bb    |  4 --
 .../recipes-bsp/images/npcm8xx-igps.inc       | 46 -------------------
 .../images/npcm8xx-tip-fw_0.6.7.0.5.6.bb      |  5 --
 .../udev/udev-nuvoton-mtd-partitions.bb       |  5 +-
 15 files changed, 19 insertions(+), 104 deletions(-)
 delete mode 100644 meta-nuvoton/recipes-bsp/images/npcm7xx-bootblock_10.10.18.bb
 delete mode 100644 meta-nuvoton/recipes-bsp/images/npcm8xx-bootblock_0.4.3.bb
 delete mode 100644 meta-nuvoton/recipes-bsp/images/npcm8xx-bootblock_0.4.6.bb
 rename meta-nuvoton/recipes-bsp/images/{npcm8xx-bootloader_0.1.0.bb => npcm8xx-bootloader_04.03.08.bb} (87%)
 delete mode 100644 meta-nuvoton/recipes-bsp/images/npcm8xx-igps-native_04.00.07.bb
 delete mode 100644 meta-nuvoton/recipes-bsp/images/npcm8xx-igps.inc
 delete mode 100644 meta-nuvoton/recipes-bsp/images/npcm8xx-tip-fw_0.6.7.0.5.6.bb

diff --git a/meta-arm/meta-arm-bsp/conf/layer.conf b/meta-arm/meta-arm-bsp/conf/layer.conf
index 9013d11f8a..3a428b054e 100644
--- a/meta-arm/meta-arm-bsp/conf/layer.conf
+++ b/meta-arm/meta-arm-bsp/conf/layer.conf
@@ -9,7 +9,7 @@ BBFILE_COLLECTIONS += "meta-arm-bsp"
 BBFILE_PATTERN_meta-arm-bsp = "^${LAYERDIR}/"
 BBFILE_PRIORITY_meta-arm-bsp = "5"
 
-LAYERSERIES_COMPAT_meta-arm-bsp = "nanbield scarthgap"
+LAYERSERIES_COMPAT_meta-arm-bsp = "nanbield scarthgap styhead walnascar"
 
 LAYERDEPENDS_meta-arm-bsp = "core meta-arm"
 # This won't be used by layerindex-fetch, but works everywhere else
diff --git a/meta-arm/meta-arm-toolchain/conf/layer.conf b/meta-arm/meta-arm-toolchain/conf/layer.conf
index 06494936ec..3b3d26b029 100644
--- a/meta-arm/meta-arm-toolchain/conf/layer.conf
+++ b/meta-arm/meta-arm-toolchain/conf/layer.conf
@@ -9,4 +9,4 @@ BBFILE_PATTERN_arm-toolchain := "^${LAYERDIR}/"
 BBFILE_PRIORITY_arm-toolchain = "5"
 
 LAYERDEPENDS_arm-toolchain = "core"
-LAYERSERIES_COMPAT_arm-toolchain = "nanbield scarthgap"
+LAYERSERIES_COMPAT_arm-toolchain = "nanbield scarthgap styhead walnascar"
diff --git a/meta-arm/meta-arm/conf/layer.conf b/meta-arm/meta-arm/conf/layer.conf
index 9e9c9dbda1..a5769110ca 100644
--- a/meta-arm/meta-arm/conf/layer.conf
+++ b/meta-arm/meta-arm/conf/layer.conf
@@ -13,7 +13,7 @@ LAYERDEPENDS_meta-arm = " \
     core \
     arm-toolchain \
 "
-LAYERSERIES_COMPAT_meta-arm = "nanbield scarthgap"
+LAYERSERIES_COMPAT_meta-arm = "nanbield scarthgap styhead walnascar"
 
 # runfvp --console needs telnet, so pull this in for testimage.
 HOSTTOOLS_NONFATAL += "telnet"
diff --git a/meta-arm/meta-arm/recipes-test/pacbti/test-pacbti.bb b/meta-arm/meta-arm/recipes-test/pacbti/test-pacbti.bb
index 331c585489..73a781dbce 100644
--- a/meta-arm/meta-arm/recipes-test/pacbti/test-pacbti.bb
+++ b/meta-arm/meta-arm/recipes-test/pacbti/test-pacbti.bb
@@ -4,7 +4,7 @@ LIC_FILES_CHKSUM = "file://pacbti.c;beginline=2;endline=2;md5=6ec41034e04432ee37
 
 SRC_URI = "file://pacbti.c"
 
-S = "${WORKDIR}"
+S = "${WORKDIR}/sources"
 
 do_compile() {
     # Compile with -zforce-bti with fatal warnings, so the link fails if PAC/BTI
diff --git a/meta-nuvoton/conf/layer.conf b/meta-nuvoton/conf/layer.conf
index 0128093abe..cf13945f32 100644
--- a/meta-nuvoton/conf/layer.conf
+++ b/meta-nuvoton/conf/layer.conf
@@ -7,7 +7,7 @@ BBFILES += "${LAYERDIR}/recipes-*/*/*.bb \
 BBFILE_COLLECTIONS += "nuvoton-layer"
 BBFILE_PATTERN_nuvoton-layer := "^${LAYERDIR}/"
 LAYERVERSION_nuvoton-layer = "1"
-LAYERSERIES_COMPAT_nuvoton-layer = "nanbield scarthgap"
+LAYERSERIES_COMPAT_nuvoton-layer = "nanbield scarthgap styhead walnascar"
 LAYERDEPENDS_nuvoton-layer:append:npcm8xx = " meta-arm"
 
 BBFILES_DYNAMIC += " \
diff --git a/meta-nuvoton/recipes-bsp/images/npcm7xx-bootblock_10.10.18.bb b/meta-nuvoton/recipes-bsp/images/npcm7xx-bootblock_10.10.18.bb
deleted file mode 100644
index f3d1aa2e57..0000000000
--- a/meta-nuvoton/recipes-bsp/images/npcm7xx-bootblock_10.10.18.bb
+++ /dev/null
@@ -1,26 +0,0 @@
-SUMMARY = "Primary bootloader for NPCM7XX (Poleg) devices"
-DESCRIPTION = "Primary bootloader for NPCM7XX (Poleg) devices"
-HOMEPAGE = "https://github.com/Nuvoton-Israel/npcm7xx-bootblock"
-LICENSE = "GPL-2.0-only"
-LIC_FILES_CHKSUM = "file://LICENSE;md5=b234ee4d69f5fce4486a80fdaf4a4263"
-
-FILENAME = "Poleg_bootblock_${PV}.bin"
-
-S = "${WORKDIR}"
-
-SRCREV = "4fa655f95547b927b0133c8ed96c88c5d14ac7b3"
-SRC_URI = " \
-    https://raw.githubusercontent.com/Nuvoton-Israel/bootblock/${SRCREV}/LICENSE;name=lic \
-    https://github.com/Nuvoton-Israel/bootblock/releases/download/BootBlock_${PV}/Poleg_bootblock_basic.bin;downloadfilename=${FILENAME};name=bin \
-"
-
-SRC_URI[lic.md5sum] = "b234ee4d69f5fce4486a80fdaf4a4263"
-SRC_URI[bin.sha256sum] = "a33f3fe96786929a8f35e986ae76bbd1bf53459770a6ece7d6777dced1d62ddf"
-
-inherit deploy
-
-do_deploy () {
-	install -D -m 644 ${WORKDIR}/${FILENAME} ${DEPLOYDIR}/Poleg_bootblock.bin
-}
-
-addtask deploy before do_build after do_compile
diff --git a/meta-nuvoton/recipes-bsp/images/npcm7xx-bootblock_10.10.19.bb b/meta-nuvoton/recipes-bsp/images/npcm7xx-bootblock_10.10.19.bb
index db6c08a22d..b3e607647e 100644
--- a/meta-nuvoton/recipes-bsp/images/npcm7xx-bootblock_10.10.19.bb
+++ b/meta-nuvoton/recipes-bsp/images/npcm7xx-bootblock_10.10.19.bb
@@ -6,7 +6,7 @@ LIC_FILES_CHKSUM = "file://LICENSE;md5=b234ee4d69f5fce4486a80fdaf4a4263"
 
 FILENAME = "Poleg_bootblock_${PV}.bin"
 
-S = "${WORKDIR}"
+S = "${WORKDIR}/sources"
 
 SRCREV = "cac8f0ed8c6e875148ec37b657fcbdd1058c2c69"
 SRC_URI = " \
diff --git a/meta-nuvoton/recipes-bsp/images/npcm8xx-bootblock_0.4.3.bb b/meta-nuvoton/recipes-bsp/images/npcm8xx-bootblock_0.4.3.bb
deleted file mode 100644
index 4e9266a26b..0000000000
--- a/meta-nuvoton/recipes-bsp/images/npcm8xx-bootblock_0.4.3.bb
+++ /dev/null
@@ -1,3 +0,0 @@
-SRCREV = "d300c35173a733a4cfa2f877477d5e72f9c3b538"
-
-require npcm8xx-bootblock.inc
diff --git a/meta-nuvoton/recipes-bsp/images/npcm8xx-bootblock_0.4.6.bb b/meta-nuvoton/recipes-bsp/images/npcm8xx-bootblock_0.4.6.bb
deleted file mode 100644
index 61de1333e7..0000000000
--- a/meta-nuvoton/recipes-bsp/images/npcm8xx-bootblock_0.4.6.bb
+++ /dev/null
@@ -1,3 +0,0 @@
-SRCREV = "b45a45bce6e557af49b43492904579edb5f084a3"
-
-require npcm8xx-bootblock.inc
diff --git a/meta-nuvoton/recipes-bsp/images/npcm8xx-bootloader/settings.json b/meta-nuvoton/recipes-bsp/images/npcm8xx-bootloader/settings.json
index 8a741dcb4b..b40d303d2a 100644
--- a/meta-nuvoton/recipes-bsp/images/npcm8xx-bootloader/settings.json
+++ b/meta-nuvoton/recipes-bsp/images/npcm8xx-bootloader/settings.json
@@ -3,11 +3,11 @@
     {
         "MC_CONFIG": "0x04"
     },
-    "key_setting_edit_me.py":
+    "key_setting_edit_me.json":
     {
         "COMBO1_OFFSET": "2048*1024"
     },
     "BootBlockAndHeader_no_tip.xml":
     {
     }
-}
+}
\ No newline at end of file
diff --git a/meta-nuvoton/recipes-bsp/images/npcm8xx-bootloader_0.1.0.bb b/meta-nuvoton/recipes-bsp/images/npcm8xx-bootloader_04.03.08.bb
similarity index 87%
rename from meta-nuvoton/recipes-bsp/images/npcm8xx-bootloader_0.1.0.bb
rename to meta-nuvoton/recipes-bsp/images/npcm8xx-bootloader_04.03.08.bb
index 69ceeaefca..59d3321992 100644
--- a/meta-nuvoton/recipes-bsp/images/npcm8xx-bootloader_0.1.0.bb
+++ b/meta-nuvoton/recipes-bsp/images/npcm8xx-bootloader_04.03.08.bb
@@ -12,14 +12,11 @@ IGPS_BRANCH ?= "main"
 SRC_URI = " \
     git://github.com/Nuvoton-Israel/igps-npcm8xx;branch=${IGPS_BRANCH};protocol=https \
 "
-SRCREV = "518d3f58f4f157373a5b1aaebaf22f80bb13d0d9"
+SRCREV = "64302c28dfd68ee80236512162602ebc24891189"
 
 S = "${WORKDIR}/git"
 
-DEPENDS = " \
-    npcm8xx-tip-fw npcm8xx-bootblock trusted-firmware-a optee-os \
-    u-boot-nuvoton npcm7xx-bingo-native openssl-native \
-"
+DEPENDS = "npcm7xx-bingo-native openssl-native"
 inherit obmc-phosphor-utils
 inherit python3native deploy
 FILE_FMT = "file://{}"
@@ -36,7 +33,7 @@ IGPS_SCRIPT_BASE = "${S}/py_scripts/ImageGeneration"
 BB_BIN = "arbel_a35_bootblock"
 BB_BIN .= "${@'_no_tip.bin' if d.getVar("TIP_IMAGE") != 'True' else '.bin'}"
 
-do_configure[dirs] = "${WORKDIR}"
+do_configure[dirs] = "${UNPACKDIR}"
 do_configure() {
     KEY_FOLDER=${IGPS_SCRIPT_BASE}/keys/openssl
     CSV_FOLDER=${IGPS_SCRIPT_BASE}/inputs/registers
@@ -55,10 +52,14 @@ do_configure() {
     # change customized settings for XML and key setting
     if [ -n "${IGPS_SETTINGS}" ];then
         cd ${S}
-        python3 ${IGPS_SCRIPT_BASE}/config_replacer.py ${WORKDIR}/${IGPS_SETTINGS}
+        python3 ${IGPS_SCRIPT_BASE}/config_replacer.py ${UNPACKDIR}/${IGPS_SETTINGS}
     fi
 }
 
+do_compile[depends] += " \
+    npcm8xx-tip-fw:do_deploy npcm8xx-bootblock:do_deploy \
+    trusted-firmware-a:do_deploy optee-os:do_deploy \
+    u-boot-nuvoton:do_deploy"
 do_compile() {
     # copy Openbmc built images
     cd ${DEPLOY_DIR_IMAGE}
diff --git a/meta-nuvoton/recipes-bsp/images/npcm8xx-igps-native_04.00.07.bb b/meta-nuvoton/recipes-bsp/images/npcm8xx-igps-native_04.00.07.bb
deleted file mode 100644
index 108a440278..0000000000
--- a/meta-nuvoton/recipes-bsp/images/npcm8xx-igps-native_04.00.07.bb
+++ /dev/null
@@ -1,4 +0,0 @@
-# tag IGPS_04.00.07
-SRCREV = "d1a2b585de580028a74fda4b90729cc5192bc28f"
-
-require npcm8xx-igps.inc
diff --git a/meta-nuvoton/recipes-bsp/images/npcm8xx-igps.inc b/meta-nuvoton/recipes-bsp/images/npcm8xx-igps.inc
deleted file mode 100644
index 7c043f808f..0000000000
--- a/meta-nuvoton/recipes-bsp/images/npcm8xx-igps.inc
+++ /dev/null
@@ -1,46 +0,0 @@
-SUMMARY = "Image Generation and Programming Scripts for NPCM8XX (Arbel) devices"
-DESCRIPTION = "Image Generation and Programming Scripts for NPCM8XX (Arbel) devices"
-HOMEPAGE = "https://github.com/Nuvoton-Israel/igps-npcm8xx"
-LICENSE = "GPLv2"
-LIC_FILES_CHKSUM = "file://LICENSE;md5=b234ee4d69f5fce4486a80fdaf4a4263"
-
-IGPS_BRANCH ?= "main"
-SRC_URI = " \
-    git://github.com/Nuvoton-Israel/igps-npcm8xx;branch=${IGPS_BRANCH};protocol=https \
-"
-
-S = "${WORKDIR}/git"
-
-DEST = "${D}${datadir}/${BPN}"
-
-# Adjust paths for use with bitbake
-do_patch() {
-	sed -i -e 's,output_binaries/tmp/,,g' ${S}/py_scripts/ImageGeneration/references/*.xml \
-		${S}/py_scripts/ImageGeneration/inputs/*.xml
-}
-
-do_install() {
-	install -d ${DEST}
-    if [ "${TIP_IMAGE}" = "True" ] ; then
-        install py_scripts/ImageGeneration/references/BootBlockAndHeader_${DEVICE_GEN}_${IGPS_MACHINE}.xml ${DEST}
-	else
-        install py_scripts/ImageGeneration/references/BootBlockAndHeader_${DEVICE_GEN}_${IGPS_MACHINE}_NoTip.xml ${DEST}
-    fi
-	install py_scripts/ImageGeneration/references/UbootHeader_${DEVICE_GEN}.xml ${DEST}
-	install py_scripts/ImageGeneration/inputs/BL31_AndHeader.xml ${DEST}
-	install py_scripts/ImageGeneration/inputs/OpTeeAndHeader.xml ${DEST}
-	install py_scripts/ImageGeneration/asn1.py ${DEST}
-	install py_scripts/ImageGeneration/BinarySignatureGenerator.py ${DEST}
-}
-
-inherit deploy
-
-do_deploy () {
-	# copy default keys to deploy folder
-	install -d ${DEPLOYDIR}
-	cp -vur py_scripts/ImageGeneration/keys/${SIGN_TYPE} ${DEPLOYDIR}/
-}
-
-inherit native
-
-addtask deploy before do_build after do_compile
diff --git a/meta-nuvoton/recipes-bsp/images/npcm8xx-tip-fw_0.6.7.0.5.6.bb b/meta-nuvoton/recipes-bsp/images/npcm8xx-tip-fw_0.6.7.0.5.6.bb
deleted file mode 100644
index 3275ec7091..0000000000
--- a/meta-nuvoton/recipes-bsp/images/npcm8xx-tip-fw_0.6.7.0.5.6.bb
+++ /dev/null
@@ -1,5 +0,0 @@
-SRCREV = "65c421f6bd7efb96c1d95fcaaf13425129fba2c0"
-
-OUTPUT_BIN = "output_binaries_${DEVICE_GEN}_${IGPS_MACHINE}"
-
-require npcm8xx-tip-fw.inc
diff --git a/meta-nuvoton/recipes-core/udev/udev-nuvoton-mtd-partitions.bb b/meta-nuvoton/recipes-core/udev/udev-nuvoton-mtd-partitions.bb
index 2b8c53d126..8ece465899 100644
--- a/meta-nuvoton/recipes-core/udev/udev-nuvoton-mtd-partitions.bb
+++ b/meta-nuvoton/recipes-core/udev/udev-nuvoton-mtd-partitions.bb
@@ -4,12 +4,13 @@ PR = "r1"
 LICENSE = "Apache-2.0"
 LIC_FILES_CHKSUM = "file://${COREBASE}/meta/files/common-licenses/Apache-2.0;md5=89aea4e17d99a7cacdbeed46a0096b10"
 
-S = "${WORKDIR}"
+S = "${WORKDIR}/sources"
+UNPACKDIR = "${S}"
 SRC_URI = "file://76-nuvoton-mtd-partitions.rules"
 
 RDEPENDS:${PN} += "udev"
 
 do_install() {
     install -d ${D}/${base_libdir}/udev/rules.d
-    install -m 0644 ${WORKDIR}/76-nuvoton-mtd-partitions.rules ${D}/${base_libdir}/udev/rules.d
+    install -m 0644 ${UNPACKDIR}/76-nuvoton-mtd-partitions.rules ${D}/${base_libdir}/udev/rules.d
 }
-- 
2.43.0

