From 32cf8b48ce0bbba4102c0f5e5ee4b13e47c8b5a2 Mon Sep 17 00:00:00 2001
From: Tomer Maimon <tmaimon77@gmail.com>
Date: Wed, 10 Apr 2024 11:13:51 +0300
Subject: [PATCH 07/23] arm64: dts: nuvoton: enable npcm8xx nodes in NPCM845
 EVB

Signed-off-by: Tomer Maimon <tmaimon77@gmail.com>
---
 .../boot/dts/nuvoton/nuvoton-npcm845-evb.dts  | 223 ++++++++++++++----
 .../nuvoton/nuvoton-npcm845-pincfg-evb.dtsi   |  20 +-
 2 files changed, 197 insertions(+), 46 deletions(-)

diff --git a/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-evb.dts b/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-evb.dts
index a04d72b142b5..92d3a21f8aa0 100644
--- a/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-evb.dts
+++ b/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-evb.dts
@@ -4,7 +4,6 @@
 /dts-v1/;
 #include "nuvoton-npcm845.dtsi"
 #include "nuvoton-npcm845-pincfg-evb.dtsi"
-#include "dell-npcm845-msgbox.dtsi"
 
 / {
 	model = "Nuvoton npcm845 Development Board (Device Tree)";
@@ -18,11 +17,18 @@ aliases {
 		ethernet3 = &gmac3;
 		mdio-gpio0 = &mdio0;
 		mdio-gpio1 = &mdio1;
-		spi0 = &spi1;
+		udc0 = &udc0;
+		udc1 = &udc1;
+		udc2 = &udc2;
+		udc3 = &udc3;
+		udc4 = &udc4;
+		udc5 = &udc5;
+		udc6 = &udc6;
+		udc7 = &udc7;
 		fiu0 = &fiu0;
-		fiu1 = &fiu1;
-		fiu2 = &fiu3;
-		fiu3 = &fiux;
+		fiu1 = &fiu3;
+		fiu2 = &fiux;
+		fiu3 = &fiu1;
 		i2c0 = &i2c0;
 		i2c1 = &i2c1;
 		i2c2 = &i2c2;
@@ -50,6 +56,7 @@ aliases {
 		i2c24 = &i2c24;
 		i2c25 = &i2c25;
 		i2c26 = &i2c26;
+		spi1 = &spi_gpio;
 	};
 
 	chosen {
@@ -60,6 +67,44 @@ memory {
 		reg = <0x0 0x0 0x0 0x40000000>;
 	};
 
+	iio-hwmon {
+		compatible = "iio-hwmon";
+		io-channels = <&adc 0>, <&adc 1>, <&adc 2>, <&adc 3>,
+			<&adc 4>, <&adc 5>, <&adc 6>, <&adc 7>;
+	};
+
+	spi_gpio: spi-gpio {
+		compatible = "spi-gpio";
+		#address-cells = <1>;
+		#size-cells = <0>;
+		gpio-sck = <&gpio0 12 GPIO_ACTIVE_HIGH>;
+		gpio-mosi = <&gpio0 13 GPIO_ACTIVE_HIGH>;
+		gpio-miso = <&gpio0 14 GPIO_ACTIVE_HIGH>;
+		num-chipselects = <1>;
+		cs-gpios = <&gpio0 15 GPIO_ACTIVE_LOW>;
+
+		eeprom@0 {
+			compatible = "atmel,at25";
+			spi-max-frequency = <5000000>;
+			size = <0x10000>;
+			pagesize = <128>;
+			reg = <0>;
+			address-width = <16>;
+		};
+	};
+
+	leds {
+		compatible = "gpio-leds";
+		heartbeat {
+			label = "heartbeat";
+			gpios = <&gpio3 2 GPIO_ACTIVE_HIGH>; /* gpio98 */
+		};
+		identify {
+			label = "identify";
+			gpios = <&gpio1 29 GPIO_ACTIVE_HIGH>; /* gpio61 */
+		};
+	};
+
 	refclk: refclk-25mhz {
 		compatible = "fixed-clock";
 		clock-output-names = "ref";
@@ -107,6 +152,26 @@ mdio1: mdio@1 {
 		phy1: ethernet-phy@1 {
 		};
 	};
+
+	tip_sram: sram@fffce000 {
+		compatible = "mmio-sram";
+		reg = <0 0xfffce000 0 0x1000>;
+		#address-cells = <1>;
+		#size-cells = <1>;
+		ranges = <0 0 0xfffce000 0x1000>;
+		ch0_shm: ch_shm@0 {
+			reg = <0 0x1000>;
+		};
+	};
+
+	tip {
+		compatible = "nuvoton,cerberus";
+		mboxes = <&tip_mbox 0 16>; /*channel 0, 16th doorbell */
+		mbox-names = "cerberus";
+		shmem = <&ch0_shm>;
+		status = "okay";
+	};
+
 };
 
 &gmac0 {
@@ -139,6 +204,31 @@ &gmac3 {
 	status = "okay";
 };
 
+&tmps {
+	status = "okay";
+};
+
+&sgpio2 {
+	status = "okay";
+	gpio-line-names =
+		"POWER_OUT","RESET_OUT","","","","","","NMI_OUT",
+		"g_led","","","","","","","",
+		"","","","","","","","",
+		"","","","","","","","",
+		"","","","","","","","",
+		"","","","","","","","",
+		"","","","","","","","",
+		"","","","","","","","",
+		"","","PS_PWROK","POST_COMPLETE","POWER_BUTTON","RESET_BUTTON","NMI_BUTTON","",
+		"","","","","","","","",
+		"","","","","","","","",
+		"","","","","","","","",
+		"","","","","","","","",
+		"","","","","","","","",
+		"","","","","","","","",
+		"","","","","","","","";
+};
+
 &serial0 {
 	status = "okay";
 };
@@ -187,7 +277,7 @@ spare1@D00000 {
 				label = "spare1";
 				reg = <0x0D00000 0x200000>;
 				};
-			spare2@0F00000 {
+			spare2@F00000 {
 				label = "spare2";
 				reg = <0x0F00000 0x200000>;
 				};
@@ -259,10 +349,21 @@ &ehci2 {
 	status = "okay";
 };
 
+&ohci1 {
+        status = "okay";
+};
+
 &sdhci {
 	status = "okay";
 };
 
+&pcie {
+	/* used for e1000e PCI -> AXI window opening */
+	dma-ranges = <0x02000000 0 0x00000000 0x0 0x00000000 0 0x40000000>;
+	npcm-pci-ep-rst = <&gpio3 24 1>;
+	status = "okay";
+};
+
 &pcimbox {
 	status = "okay";
 };
@@ -291,9 +392,13 @@ &udc5 {
 	status = "okay";
 };
 
-/*&udc9 {
+&udc6 {
 	status = "okay";
-};*/
+};
+
+&udc7 {
+	status = "okay";
+};
 
 &gcr {
 	udc9_mux: mux-controller {
@@ -318,8 +423,28 @@ kcs3: kcs3@0 {
 	};
 };
 
-&bpc {
-	nuvoton,monitor-ports = <0x80>;
+&lpc_host {
+	lpc_bpc: lpc_bpc@40 {
+		monitor-ports = <0x80>;
+		status = "okay";
+	};
+};
+
+&peci0 {
+	cmd-timeout-ms = <1000>;
+	npcm,pull-down = <0>;
+	npcm,host-neg-bit-rate = <15>;
+	#address-cells = <1>;
+	#size-cells = <0>;
+	status = "okay";
+	intel-peci-dimmtemp@30 {
+		compatible = "intel,peci-client";
+		reg = <0x30>;
+		status = "okay";
+	};
+};
+
+&jtm1 {
 	status = "okay";
 };
 
@@ -343,8 +468,6 @@ &pwm_fan {
 		&pwm2_pins &pwm3_pins
 		&pwm4_pins &pwm5_pins
 		&pwm6_pins &pwm7_pins
-		&pwm8_pins &pwm9_pins
-		&pwm10_pins &pwm11_pins
 		&fanin0_pins &fanin1_pins
 		&fanin2_pins &fanin3_pins
 		&fanin4_pins &fanin5_pins
@@ -382,18 +505,18 @@ fan@5 {
 		cooling-levels = /bits/ 8 <127 255>;
 	};
 	fan@6 {
-		reg = <0x09>;
+		reg = <0x06>;
 		fan-tach-ch = /bits/ 8 <0x0C 0x0D>;
 		cooling-levels = /bits/ 8 <127 255>;
 	};
 	fan@7 {
-		reg = <0x08>;
+		reg = <0x07>;
 		fan-tach-ch = /bits/ 8 <0x0E 0x0F>;
 		cooling-levels = /bits/ 8 <127 255>;
 	};
 };
 
-&spi1 {
+&pspi {
 	cs-gpios = <&gpio0 20 GPIO_ACTIVE_LOW>;
 	status = "okay";
 	Flash@0 {
@@ -411,24 +534,39 @@ partition@0 {
 
 &i2c0 {
 	status = "okay";
-	/* Only SVB */
-	/*lm75@48 {
-		compatible = "lm75";
-		reg = <0x48>;
-		status = "okay";
-	};*/
+
 };
 
-/*&i2c1 {
+&i2c1 {
 	status = "okay";
+	#address-cells = <1>;
+	#size-cells = <0>;
+	eeprom@50 {
+		compatible = "atmel,24c256";
+		reg = <0x50>;
+	};
 };
 
 &i2c2 {
 	status = "okay";
+	#address-cells = <1>;
+	#size-cells = <0>;
+	ipmb@10 {
+		compatible = "ipmb-dev";
+		reg = <0x10>;
+		i2c-protocol;
+	};
 };
 
 &i2c3 {
 	status = "okay";
+	#address-cells = <1>;
+	#size-cells = <0>;
+	ipmb@11 {
+		compatible = "ipmb-dev";
+		reg = <0x11>;
+		i2c-protocol;
+	};
 };
 
 &i2c4 {
@@ -441,6 +579,8 @@ &i2c5 {
 
 &i2c6 {
 	status = "okay";
+	#address-cells = <1>;
+	#size-cells = <0>;
 	tmp100@48 {
 		compatible = "tmp100";
 		reg = <0x48>;
@@ -506,11 +646,6 @@ &i2c20 {
 
 &i2c21 {
 	status = "okay";
-	npct601@57 {
-		compatible = "infineon,slb9673";
-		reg = <0x2E>;		
-		status = "okay";
-	};
 };
 
 &i2c22 {
@@ -531,7 +666,7 @@ &i2c25 {
 
 &i2c26 {
 	status = "okay";
-};*/
+};
 
 &i3c0 {
         status = "okay";
@@ -545,36 +680,36 @@ &i3c1 {
         i2c-scl-hz = <400000>;
 };
 
+&mc {
+	status = "okay";
+};
+
 &pinctrl {
 	pinctrl-names = "default";
 	pinctrl-0 = <
 			&jtag2_pins
-			&gpo187ol_pins
-			&gpo187_pins
-			&gpio114ol_pins
 			&lpc_pins
 			&spix_pins
+			&pin4_slew
+			&pin5_slew
+			&pin6_slew
+			&pin7_slew
 			&pin108_slew
-			&pin109_slew>;
+			&pin109_slew
+			&pin240_slew
+			&pin241_slew
+			&pin242_slew
+			&pin243_slew>;
 };
 
-&peci0 {
-	cmd-timeout-ms = <1000>;
-	pull-down = <0>;
-	host-neg-bit-rate = <15>;
+&vcd {
 	status = "okay";
-
-	intel-peci-dimmtemp@30 {
-		compatible = "intel,peci-client";
-		reg = <0x30>;
-		status = "okay";
-	};
 };
 
-&vcd {
+&ece {
 	status = "okay";
 };
 
-&ece {
+&tip_mbox {
 	status = "okay";
 };
diff --git a/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-pincfg-evb.dtsi b/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-pincfg-evb.dtsi
index b6066db2ddc0..5d75882c1a4a 100644
--- a/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-pincfg-evb.dtsi
+++ b/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845-pincfg-evb.dtsi
@@ -3,12 +3,28 @@
 
 / {
 	pinctrl: pinctrl@f0800260 {
+		pin4_slew: pin4_slew {
+			pins = "GPIO4/IOX2_DI/SMB1D_SDA";
+			slew-rate = <1>;
+		};
+		pin5_slew: pin5_slew {
+			pins = "GPIO5/IOX2_LD/SMB1D_SCL";
+			slew-rate = <1>;
+		};
+		pin6_slew: pin6_slew {
+			pins = "GPIO6/IOX2_CK/SMB2D_SDA";
+			slew-rate = <1>;
+		};
+		pin7_slew: pin7_slew {
+			pins = "GPIO7/IOX2_D0/SMB2D_SCL";
+			slew-rate = <1>;
+		};
 		pin33_slew: pin33-slew {
-			pins = "I3C4_SCL";
+			pins = "GPIO33/I3C4_SCL";
 			slew-rate = <1>;
 		};
 		pin34_slew: pin34-slew {
-			pins = "I3C4_SDA";
+			pins = "GPIO34/I3C4_SDA";
 			slew-rate = <1>;
 		};
 		pin106_slew: pin106-slew {
-- 
2.43.0

